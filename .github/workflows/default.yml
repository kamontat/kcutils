name: Default

on:
  push:

defaults:
  run:
    shell: bash

jobs:
  # Test and report result in sonarqube (run only primary node version)
  testflow:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0 # require by sonar to disable shadow clone for sonar analysis correctly
      - name: Setup project
        uses: ./.github/actions/setup
        with:
          node_version: 16
          with_build: true
      - name: Start testflow
        uses: ./.github/actions/testflow
        with:
          with_lint: true
          with_unittest: true
          with_sonar: true
          github_apikey: ${{ secrets.GITHUB_TOKEN }}
          sonar_apikey: ${{ secrets.SONAR_TOKEN }}
          collect_coverage: true

  # Test on different node version to ensure backward compatible
  test:
    runs-on: ubuntu-latest
    needs:
      - testflow
    strategy:
      matrix:
        node-version: [12, 14, 17]
    steps:
      - uses: actions/checkout@v2
      - name: Setup project
        uses: ./.github/actions/setup
        with:
          with_build: true
          node_version: ${{ matrix.node-version }}
      - name: Start testflow
        uses: ./.github/actions/testflow
        with:
          with_unittest: true
